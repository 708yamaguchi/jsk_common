<launch>
  <arg name="namespace"  default="multisense" />
  <arg name="use_resize" default="true" />
  <arg name="use_compress" default="false" />
  <arg name="use_theora" default="false" />
  <arg name="run_laser_pipeline" default="false" />
  <arg name="fixed_frame_id" default="head_root" />
  <!-- Run stereo_image_proc -->
  
  <group ns="$(arg namespace)">
    <node pkg="nodelet" type="nodelet" name="stereo_manager"
          args="manager" />
    <group unless="$(arg use_compress)">
      <node pkg="nodelet" type="nodelet" name="left_image_rect_color_relay"
            args="load jsk_topic_tools/Relay stereo_manager">
        <remap from="~input" to="/$(arg namespace)_local/left/image_rect_color" />
        <remap from="~output" to="/$(arg namespace)/left/image_rect_color" />
      </node>
    </group>
    <group if="$(arg use_compress)">
      <group unless="$(arg use_theora)">
        <node pkg="nodelet" type="nodelet" name="left_image_rect_color_relay"
              args="load jsk_topic_tools/Relay stereo_manager">
          <remap from="~input" to="/$(arg namespace)_local/left/image_rect_color/compressed" />
          <remap from="~output" to="/$(arg namespace)/left/image_rect_color_compressed/compressed" />
        </node>
        <node pkg="image_transport" type="republish" name="left_image_rect_color_decompress" args="compressed">
          <remap from="in" to="/$(arg namespace)/left/image_rect_color_compressed" />
          <remap from="out" to="/$(arg namespace)/left/image_rect_color" />
          <remap from="/$(arg namespace)/left/image_rect_color_decompressed" to="/$(arg namespace)/left/image_rect_color"/>
        </node>
      </group>
      <group if="$(arg use_theora)">
        <node pkg="nodelet" type="nodelet" name="left_image_rect_color_relay"
              args="load jsk_topic_tools/Relay stereo_manager">
          <remap from="~input" to="/$(arg namespace)_local/left/image_rect_color/theora" />
          <remap from="~output" to="/$(arg namespace)/left/image_rect_color_compressed/theora" />
        </node>
        <node pkg="image_transport" type="republish" name="left_image_rect_color_decompress" args="theora">
          <remap from="in" to="/$(arg namespace)/left/image_rect_color_compressed" />
          <remap from="out" to="/$(arg namespace)/left/image_rect_color" />
        </node>
      </group>
    </group>
    <node pkg="nodelet" type="nodelet" name="left_camera_info_relay"
          args="load jsk_topic_tools/Relay stereo_manager">
      <remap from="~input" to="/$(arg namespace)_local/left/camera_info" />
      <remap from="~output" to="/$(arg namespace)/left/camera_info" />
    </node>
    <node pkg="nodelet" type="nodelet" name="point_cloud_xyz"
          args="load depth_image_proc/point_cloud_xyz stereo_manager">
      <remap from="camera_info" to="depth/camera_info" />
      <remap from="image_rect" to="depth" />
      <remap from="points" to="organized_image_points2" />
    </node>
    <node pkg="nodelet" type="nodelet" name="point_cloud_xyzrgb"
          args="load depth_image_proc/point_cloud_xyzrgb stereo_manager">
      <remap from="rgb/camera_info" to="/$(arg namespace)/left/camera_info" />
      <remap from="rgb/image_rect_color" to="left/image_rect_color" />
      <remap from="depth_registered/image_rect" to="depth" />
      <remap from="depth_registered/points" to="organized_image_points2_color" />
    </node> 
  </group>
  <include file="$(find jsk_pcl_ros)/launch/multi_resolution_organized_pointcloud.launch" if="$(arg use_resize)">
    <arg name="NAMESPACE" value="$(arg namespace)" />
    <arg name="INPUT" value="/$(arg namespace)/organized_image_points2_color" />
    <arg name="RUN_MANAGER" value="false" />
    <arg name="MANAGER" value="/$(arg namespace)/stereo_manager" />
  </include>
  <include file="$(find jsk_tilt_laser)/launch/multisense_laser_pipeline.launch" if="$(arg run_laser_pipeline)">
    <arg name="namespace" value="$(arg namespace)" />
    <arg name="fixed_frame_id" value="$(arg fixed_frame_id)" />
  </include>
</launch>
